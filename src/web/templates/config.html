{% extends "base.html" %}

{% block title %}Configuração - {{ super() }}{% endblock %}

{% block content %}
<h2>Configuração</h2>
<p>Gerencie as configurações do bot aqui. As chaves de API são criptografadas e nunca mais são mostradas após salvar.</p>

<div id="alert-placeholder"></div>

<form id="config-form">
    <h3>Segurança e Credenciais</h3>
    <div class="card">
        <div class="form-group">
            <label for="admin_password">Alterar Senha do Administrador</label>
            <input type="password" id="admin_password" name="admin_password" placeholder="Deixe em branco para manter a senha atual">
        </div>
        <hr>
        <h4>Chaves de API</h4>
        <div class="form-group">
            <label for="binance_api_key">Chave de API da Binance</label>
            <input type="text" id="binance_api_key" name="binance_api_key" placeholder="{% if settings.binance.api_key_encrypted %}Já definida, insira uma nova chave para alterar{% else %}Insira sua chave de API da Binance{% endif %}">
        </div>
        <div class="form-group">
            <label for="binance_secret_key">Chave Secreta da Binance</label>
            <input type="password" id="binance_secret_key" name="binance_secret_key" placeholder="{% if settings.binance.secret_key_encrypted %}Já definida, insira uma nova chave para alterar{% else %}Insira sua chave secreta da Binance{% endif %}">
        </div>
        <div class="form-group">
            <label for="cmc_api_key">Chave de API do CoinMarketCap</label>
            <input type="text" id="cmc_api_key" name="cmc_api_key" placeholder="{% if settings.cmc.api_key_encrypted %}Já definida, insira uma nova chave para alterar{% else %}Insira sua chave de API do CoinMarketCap{% endif %}">
        </div>
        <button type="button" id="test-keys-btn" class="secondary">Testar Chaves de API</button>
    </div>

    <h3>Estratégia de Rebalanceamento</h3>
    <div class="card">
        <div class="form-group">
            <label for="dry_run">Modo de Simulação</label>
            <select id="dry_run" name="dry_run">
                <option value="true" {% if settings.dry_run %}selected{% endif %}>Ativado (Simular transações, sem ordens reais)</option>
                <option value="false" {% if not settings.dry_run %}selected{% endif %}>Desativado (Executar transações reais)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="strategy">Tipo de Estratégia</label>
            <select id="strategy" name="strategy">
                <option value="periodic" {% if settings.strategy == 'periodic' %}selected{% endif %}>Periódica</option>
                <option value="threshold" {% if settings.strategy == 'threshold' %}selected{% endif %}>Por Limite</option>
            </select>
        </div>
        <div class="form-group">
            <label for="periodic_hours">Intervalo Periódico (Horas)</label>
            <input type="number" id="periodic_hours" name="periodic_hours" value="{{ settings.periodic_hours }}" min="1">
        </div>
        <div class="form-group">
            <label for="threshold_pct">Limite de Rebalanceamento (%)</label>
            <input type="number" id="threshold_pct" name="threshold_pct" value="{{ settings.threshold_pct }}" min="0.1" step="0.1">
        </div>
    </div>

    <h3>Portfólio e Negociação</h3>
    <div class="card">
        <div class="form-group">
            <label for="base_pair">Par Base</label>
            <input type="text" id="base_pair" name="base_pair" value="{{ settings.base_pair }}">
        </div>
        <div class="form-group">
            <label for="max_cmc_rank">Rank Máximo no CoinMarketCap</label>
            <input type="number" id="max_cmc_rank" name="max_cmc_rank" value="{{ settings.max_cmc_rank }}" min="10" max="5000">
        </div>
         <div class="form-group">
            <label for="min_trade_value_usd">Valor Mínimo da Transação (USD)</label>
            <input type="number" id="min_trade_value_usd" name="min_trade_value_usd" value="{{ settings.min_trade_value_usd }}" min="10" step="1">
        </div>
        <hr>
        <h4>Alocações Alvo (<span id="total-alloc-pct">0</span>%)</h4>
        <div id="allocations-container">
            {% for symbol, pct in settings.allocations.items() %}
            <div class="allocation-item">
                <input type="text" name="allocations[{{ symbol }}]" placeholder="Ativo (ex: BTC)" value="{{ symbol }}" class="alloc-symbol">
                <input type="number" name="allocations[{{ symbol }}]" placeholder="%" value="{{ pct }}" min="0" max="100" step="0.1" class="alloc-pct">
                <button type="button" class="remove-alloc-btn">&times;</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" id="add-alloc-btn" class="secondary">Adicionar Ativo</button>
    </div>

    <div class="form-actions">
        <button type="submit" id="save-btn">Salvar Configuração</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const allocationsContainer = document.getElementById('allocations-container');
    const addAllocBtn = document.getElementById('add-alloc-btn');
    const totalPctSpan = document.getElementById('total-alloc-pct');
    const form = document.getElementById('config-form');
    const saveBtn = document.getElementById('save-btn');
    const testKeysBtn = document.getElementById('test-keys-btn');
    const alertPlaceholder = document.getElementById('alert-placeholder');

    function createAlert(message, type = 'danger') {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        alertPlaceholder.innerHTML = ''; // Clear previous alerts
        alertPlaceholder.append(wrapper);
    }

    function calculateTotalAllocation() {
        let total = 0;
        document.querySelectorAll('.alloc-pct').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        totalPctSpan.textContent = total.toFixed(1);
        totalPctSpan.style.color = Math.round(total) === 100 ? 'var(--success-color)' : 'var(--danger-color)';
    }

    function addAllocationRow(symbol = '', pct = '') {
        const div = document.createElement('div');
        div.className = 'allocation-item';
        div.innerHTML = `
            <input type="text" placeholder="Ativo (ex: BTC)" value="${symbol.toUpperCase()}" class="alloc-symbol">
            <input type="number" placeholder="%" value="${pct}" min="0" max="100" step="0.1" class="alloc-pct">
            <button type="button" class="remove-alloc-btn">&times;</button>
        `;
        allocationsContainer.appendChild(div);
        div.querySelector('.remove-alloc-btn').addEventListener('click', () => div.remove());
        div.querySelector('.alloc-pct').addEventListener('input', calculateTotalAllocation);
    }

    addAllocBtn.addEventListener('click', () => addAllocationRow());

    allocationsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-alloc-btn')) {
            e.target.closest('.allocation-item').remove();
            calculateTotalAllocation();
        }
    });

    allocationsContainer.addEventListener('input', function(e) {
        if (e.target.classList.contains('alloc-pct')) {
            calculateTotalAllocation();
        }
    });

    // Handle form submission
    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        saveBtn.textContent = 'Salvando...';
        saveBtn.disabled = true;

        const formData = new FormData();
        // Collect all form data
        new FormData(form).forEach((value, key) => {
            // We handle allocations separately
            if (!key.startsWith('allocations[')) {
                formData.append(key, value);
            }
        });

        // Collect allocations correctly
        document.querySelectorAll('.allocation-item').forEach(item => {
            const symbol = item.querySelector('.alloc-symbol').value.toUpperCase();
            const pct = item.querySelector('.alloc-pct').value;
            if (symbol && pct) {
                formData.append(`allocations[${symbol}]`, pct);
            }
        });

        try {
            const response = await fetch('/api/v1/config', {
                method: 'POST',
                body: new URLSearchParams(formData) // FastAPI Form depends on this format
            });

            if (response.ok) {
                createAlert('Configuração salva com sucesso!', 'success');
                // Optionally reload or update UI
                setTimeout(() => window.location.reload(), 1000);
            } else {
                const errorData = await response.json();
                createAlert(`Falha ao salvar: ${errorData.detail || 'Erro desconhecido'}`);
            }
        } catch (error) {
            createAlert(`Ocorreu um erro: ${error.message}`);
        } finally {
            saveBtn.textContent = 'Salvar Configuração';
            saveBtn.disabled = false;
        }
    });

    // Handle Test API Keys
    testKeysBtn.addEventListener('click', async function () {
        testKeysBtn.textContent = 'Testando...';
        testKeysBtn.disabled = true;

        // First, save the current keys in the form if any are entered
        await fetch('/api/v1/config', {
            method: 'POST',
            body: new URLSearchParams(new FormData(form))
        });

        try {
            const response = await fetch('/api/v1/config/test-keys', { method: 'POST' });
            const result = await response.json();

            if (response.ok) {
                let report = '<strong>Resultados do Teste de Chave de API:</strong><br>';
                report += `Binance: <span style="color:var(--success-color)">${result.binance.message}</span><br>`;
                report += `CoinMarketCap: <span style="color:var(--success-color)">${result.cmc.message}</span>`;
                createAlert(report, 'success');
            } else {
                 let report = '<strong>Resultados do Teste de Chave de API:</strong><br>';
                 const details = result.detail;
                 report += `Binance: <span style="color:${details.binance.status === 'success' ? 'var(--success-color)' : 'var(--danger-color)'}">${details.binance.message}</span><br>`;
                 report += `CoinMarketCap: <span style="color:${details.cmc.status === 'success' ? 'var(--success-color)' : 'var(--danger-color)'}">${details.cmc.message}</span>`;
                 createAlert(report, 'danger');
            }
        } catch (error) {
            createAlert(`Ocorreu um erro: ${error.message}`);
        } finally {
            testKeysBtn.textContent = 'Testar Chaves de API';
            testKeysBtn.disabled = false;
        }
    });

    // Initial calculation
    calculateTotalAllocation();
});
</script>
{% endblock %}
