{% extends "base.html" %}

{% block title %}{{ _('Dashboard') }} - {{ super() }}{% endblock %}

{% block content %}
<div id="alert-placeholder"></div>

<div class="card">
    <h2>{{ _('Dashboard') }}</h2>
    <p>{{ _('Manually trigger a rebalance run. The bot will use the currently saved configuration.') }}</p>
    <div class="form-actions">
        <button id="run-rebalance-btn" class="button">{{ _('Run Rebalance') }}</button>
        <button id="run-dry-run-btn" class="button secondary">{{ _('Run Dry Run') }}</button>
    </div>
</div>

<div class="card">
    <h2>{{ _('Last Run Status') }}</h2>
    {% if last_run %}
    <p><strong>{{ _('Run ID:') }}</strong> {{ last_run.run_id }}</p>
    <p><strong>{{ _('Date & Time:') }}</strong> {{ last_run.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} UTC</p>
    <p><strong>{{ _('Status:') }}</strong> <span class="status-{{ last_run.status.lower() }}">{{ last_run.status }}</span> {% if last_run.is_dry_run %}({{ _('Dry Run') }}){% endif %}</p>
    <p><strong>{{ _('Base Pair:') }}</strong> {{ last_run.base_pair }}</p>
    <p><strong>{{ _('Trigger:') }}</strong> {% if last_run.trigger == 'scheduled' %}<span class="mode-live">{{ _('Scheduled') }}</span>{% else %}<span class="mode-dry">{{ _('Manual') }}</span>{% endif %}</p>
    <p><strong>{{ _('Summary:') }}</strong> {{ last_run.summary_message }}</p>
    {% if last_run.total_fees_usd is not none %}
    <p><strong>{{ _('Total Fee Cost (Estimated):') }}</strong> ${{ "%.2f"|format(last_run.total_fees_usd) }}</p>
    {% endif %}

    {% if last_run.projected_balances %}
    <h4>{{ _('Projected Balances After Run') }}</h4>
    <table>
        <thead>
            <tr>
                <th>{{ _('Asset') }}</th>
                <th>{{ _('New Quantity') }}</th>
                <th>{{ _('New Value (%(base_pair)s)', base_pair=last_run.base_pair) }}</th>
                <th>{{ _('New Value (USD)') }}</th>
            </tr>
        </thead>
        <tbody>
            {% set rows = sorted_balances or [] %}
            {% if rows|length == 0 %}
            <tr>
                <td colspan="4">{{ _('No projected balance data available.') }}</td>
            </tr>
            {% else %}
            {% for asset, details in rows %}
            {% set details_map = details if details is mapping else {} %}
            {% set quantity = details_map.get('quantity', 0) %}
            {% set value_usd = details_map.get('value_usd') %}
            {% set value_base = details_map.get('value_in_base', value_usd or 0) %}
            <tr>
                <td>{{ asset }}</td>
                <td>{{ "%.8f"|format(quantity|float) }}</td>
                <td>{{ "%.2f"|format(value_base|float) }} {{ last_run.base_pair }}</td>
                <td>
                    {% if value_usd is not none %}
                    ${{ "%.2f"|format(value_usd|float) }}
                    {% else %}
                    â€”
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
    {% endif %}

    {% if last_run.errors %}
    <div class="errors">
        <strong>{{ _('Errors:') }}</strong>
        <ul>
            {% for error in last_run.errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% else %}
    <p>{{ _('No rebalance runs have been recorded yet.') }}</p>
    {% endif %}
</div>

<div class="card">
    <h2>{{ _('Current Balances') }}</h2>
    <div id="balances-loading">{{ _('Loading balances...') }}</div>
    <div id="balances-content" style="display:none;">
        <h3 id="total-balance-base" class="balance-primary">0</h3>
        <p id="total-balance-usd" class="balance-secondary"></p>
        <p id="base-conversion-note" class="text-muted"></p>
        <table>
            <thead>
                <tr>
                    <th>{{ _('Asset') }}</th>
                    <th>{{ _('Quantity') }}</th>
                    <th id="value-header-base">{{ _('Value (Base)') }}</th>
                    <th id="value-header-usd">{{ _('Value (USD)') }}</th>
                </tr>
            </thead>
            <tbody id="balances-table-body">
                <!-- Rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>
    <div id="balances-error" style="display:none; color: var(--danger-color);"></div>
</div>

<div class="card">
    <h2>{{ _('Portfolio Value History') }}</h2>
    <p id="portfolio-history-empty" class="chart-placeholder" style="display:none;">{{ _('No history available yet.') }}</p>
    <div id="portfolio-history-wrapper" class="chart-wrapper" style="display:none;">
        <canvas id="portfolio-history-chart" height="220"></canvas>
    </div>
</div>

<div class="card">
    <h2>{{ _('Performance by Asset') }}</h2>
    <p id="asset-charts-empty" class="chart-placeholder" style="display:none;">{{ _('No history available for assets.') }}</p>
    <div id="asset-charts-container" class="asset-charts-grid"></div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="/static/js/dashboard.js"></script>
{% endblock %}
